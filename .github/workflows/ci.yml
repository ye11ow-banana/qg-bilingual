name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache HF hub
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-${{ hashFiles('configs/**', 'pyproject.toml') }}

      - name: Install uv
        run: pipx install uv

      - name: Sync environment
        run: uv sync

      - name: Pre-commit (ruff/black/mypy)
        run: |
          uv run pre-commit install
          uv run pre-commit run --all-files

      - name: Run unit tests (pytest)
        env:
          HF_HUB_DISABLE_TELEMETRY: 1
        run: uv run pytest -q

      - name: Validate data (EN/UA)
        run: |
          uv run python data/scripts/validate_jsonl.py --path data/artifacts/en/val.jsonl --lang en --write-stats data/stats_en.json
          uv run python data/scripts/validate_jsonl.py --path data/artifacts/ua/val.jsonl --lang ua --write-stats data/stats_ua.json

      - name: Smoke training (T5, 1%)
        run: uv run python -m qg_bilingual.train --config configs/train_t5_smoke_en.yaml

      - name: QGâ†’QA on smoke outputs
        run: uv run python -m qg_bilingual.eval.qg2qa --config configs/qg2qa_en.yaml --input runs/t5_smoke_en/samples_val.jsonl --out runs/t5_smoke_en/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            runs/t5_smoke_en/metrics_val.json
            runs/t5_smoke_en/qg2qa_val.json
            data/stats_en.json
            data/stats_ua.json
